<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西洋棋復盤工具</title>

    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- 基本設定 & 顏色 --- */
        :root {
            --bg-color: #f4f4f5;
            --card-bg: #ffffff;
            --border-color: #e4e4e7;
            --text-primary: #18181b;
            --text-secondary: #52525b;
            --blue-light: #dbeafe;
            --red-light: #ffe4e6;
            --orange-light: #fffbeb;
            --yellow-light: #fefce8;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-primary);
            min-height: 100vh;
            box-sizing: border-box;
        }
        * {
             box-sizing: border-box;
        }

        /* --- 主要佈局容器 --- */
        #app-container {
            display: flex;
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            height: calc(100vh - 40px);
            align-items: stretch;
        }

        /* --- 左側：輸入區 --- */
        #input-section {
            flex: 0 0 260px;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        #input-section h4 { margin-top: 0; margin-bottom: 10px;}
        #pgn-text-input { width: 100%; flex-grow: 1; min-height: 150px; margin-top: 10px; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; margin-bottom: 15px; }
        #analyze-button { font-size: 1.1em; padding: 12px 16px; width: 100%; background-color: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; margin-top: auto; }
        #analyze-button:hover { background-color: #1d4ed8; }

        /* --- 中間：棋盤區 --- */
        #board-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #board-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            width: fit-content;
            height: fit-content;
        }
        
        /* --- 棋盤與箭頭容器 --- */
        #board-container-wrapper {
            position: relative;
            width: 560px;
            height: 560px;
        }
        #myBoard {
            width: 100%;
            height: 100%;
        }
        /* SVG 箭頭層 (覆蓋在棋盤上) */
        #arrow-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 讓滑鼠事件穿透 SVG */
            
            /* 【修改】z-index: 2 (在棋子之下，但在黃色高亮之上) */
            z-index: 2; 
        }

        #board-options {
             margin-top: 15px;
             display: flex;
             justify-content: center;
             gap: 20px;
             width: 100%;
        }
         #board-options label {
             color: var(--text-secondary);
             font-size: 0.9em;
             margin-right: 5px;
        }
         #board-options select {
             padding: 5px;
             border-radius: 4px;
             border: 1px solid var(--border-color);
        }

        /* --- 右側：分析區 --- */
        #sidebar {
            flex: 0 0 380px;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #analysis-controls {
             display: flex;
             flex-direction: column;
             flex-grow: 1;
             min-height: 0;
        }

        #opening-name-display {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-style: italic;
            line-height: 1.4;
            word-wrap: break-word;
        }
        #win-rate-text { font-size: 1.1em; font-weight: bold; margin-bottom: 8px; text-align: center; color: var(--text-secondary); }
        #win-rate-bar-container { width: 100%; height: 20px; background-color: #27272a; border-radius: 4px; overflow: hidden; border: 1px solid #555; display: flex; margin-bottom: 10px;}
        #white-bar { width: 50%; height: 100%; background-color: #f9fafb; transition: width 0.3s ease-out; }
        #move-controls { display: flex; gap: 8px; margin-bottom: 10px;}
        #move-controls button { font-size: 0.9em; padding: 8px 10px; flex: 1; border: 1px solid var(--border-color); background-color: var(--card-bg); border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        #move-controls button#mute-toggle-button { flex: 0 0 auto; width: 35px; height: 35px; padding: 5px; }
        #move-controls button img { width: 20px; height: 20px; display: block; margin: auto; }
        #move-controls button:hover { background-color: var(--bg-color); }

        #summary-toggle { cursor: pointer; margin-top: 10px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; font-size: 1.1em; }
        #analysis-summary-content { padding: 10px; border: 1px solid var(--border-color); background-color: var(--bg-color); border-radius: 6px; margin-bottom: 10px; font-size: 0.9em; max-height: 150px; overflow-y: auto;}
        .summary-player-section { margin-bottom: 5px; }
        .summary-player-section strong { font-size: 1em; }
        .summary-player-section ul { list-style-type: none; padding-left: 10px; margin: 3px 0 0 0; font-size: 0.85em; }

        #analysis-container { border: 1px solid var(--border-color); width: 100%; flex-grow: 1; overflow-y: auto; border-radius: 6px; min-height: 200px; }
        #analysis-container h3 { margin: 10px; font-size: 1.1em; }
        #analysis-container p { padding: 10px; color: var(--text-secondary); }

        /* --- 棋步列表樣式 --- */
        .move-list-container { font-size: 0.85em; }
        .move-pair { display: flex; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .move-pair:last-child { border-bottom: none; }
        .move-pair:hover { background-color: var(--bg-color); }
        .move-item-col.selected { background-color: var(--blue-light); }
        .move-number { flex: 0 0 25px; padding: 6px 4px; text-align: right; color: var(--text-secondary); border-right: 1px solid var(--border-color); }
        .move-item-col { flex: 1; padding: 6px 8px; position: relative; }
        .move-item-col:first-of-type { border-right: 1px solid var(--border-color); }
        .move-san { font-weight: bold; }
        .move-col-analysis { display: block; margin-top: 3px; font-size: 0.9em; }
        .analysis-detail, .analysis-detail-good {
            padding: 3px 5px;
            border-radius: 4px;
            margin-top: 3px;
            font-weight: bold;
            color: var(--text-primary); /* 改回預設黑色文字 */
        }
        
        /* 2. 為新的 class 添加背景顏色 */

        /* 最佳 (Best Move) - 淺藍色背景 */
        .analysis-detail-good.quality-best {
            background-color: var(--blue-light);
            border: 1px solid #bfdbfe;
        }

        /* 太棒了 (Excellent) - 淺綠色背景 */
        .analysis-detail-good.quality-excellent {
            background-color: #dcfce7;
            border: 1px solid #bbf7d0;
        }

        /* 很棒 (Good) & 開局 (Book) - 淺灰色背景 */
        .analysis-detail-good.quality-good {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            font-weight: normal; /* "Good" 和 "Book" 不需要粗體 */
        }
        .move-item-col.inaccuracy .analysis-detail { background-color: var(--yellow-light); border: 1px solid #fde047; }
        .move-item-col.mistake .analysis-detail { background-color: var(--orange-light); border: 1px solid #fcd34d; }
        .move-item-col.blunder .analysis-detail { background-color: var(--red-light); border: 1px solid #fda4af; }

/* --- 棋盤格子樣式 --- */
        /* 使用 [class*="..."] 選擇器來匹配 chessboard.js 的動態 class 名稱
           並使用 !important 來確保最高優先級。
        */
        div#myBoard.board-theme-wood div[class*="black-"] { background-color: #b58863 !important; color: #f0d9b5 !important; }
        div#myBoard.board-theme-wood div[class*="white-"] { background-color: #f0d9b5 !important; color: #b58863 !important; }
        
        div#myBoard.board-theme-green div[class*="black-"] { background-color: #769656 !important; color: #eeeed2 !important; }
        div#myBoard.board-theme-green div[class*="white-"] { background-color: #eeeed2 !important; color: #769656 !important; }
        
        div#myBoard.board-theme-blue div[class*="black-"] { background-color: #8ca2ad !important; color: #dee3e6 !important; }
        div#myBoard.board-theme-blue div[class*="white-"] { background-color: #dee3e6 !important; color: #8ca2ad !important; }
        
        div#myBoard.board-theme-grey div[class*="black-"] { background-color: #ababab !important; color: #f0f0f0 !important; }
        div#myBoard.board-theme-grey div[class*="white-"] { background-color: #f0f0f0 !important; color: #ababab !important; }


        /* --- 高亮樣式 --- */
        /*
         * 【最終解決方案 - v6】
         * 解決「棋子被蓋住」的 CSS 堆疊問題
        */
        
        /* 1. 讓格子成為定位基準，並建立一個新的「堆疊上下文」
         * 'isolation: isolate' 是關鍵。
         * 它讓這個 div 成為一個獨立的圖層世界。
        */
        .highlight-last-move {
            position: relative; 
            isolation: isolate; /* 建立新的堆疊上下文 */
        }
        
        /* 2. 創建螢光筆圖層 */
        .highlight-last-move::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            
            background-color: rgba(255, 235, 59, 0.7); 
            
            /* * 將 z-index 設為 -1。
             * 因為 'isolation: isolate' 的關係，
             * -1 會將此圖層放在「父層的背景之上」
             * 但在「父層的內容 (棋子<img>) 之下」。
             * 這就是我們要的！
            */
            z-index: -1; 
        }

        /* 3. 【重要】
         * 請「刪除」掉您 CSS 中任何有關
         * .highlight-last-move img { ... } 的規則。
         * (也就是 v5 版本的第三點)
        */

    </style>
</head>
<body>

    <div id="app-container">

        <!-- 左側：輸入區 -->
        <div id="input-section">
            <h4>1. 上傳你的 PGN 檔案</h4>
            <input type="file" id="pgn-file-input" accept=".pgn">
            <hr style="margin: 15px 0;">
            <h4>2. 或直接貼上 PGN 內容</h4>
            <textarea id="pgn-text-input" placeholder="在這裡貼上 PGN..."></textarea>
            <button id="analyze-button">開始分析</button>
        </div>

        <!-- 中間：棋盤區 -->
        <div id="board-section">
            <div id="board-card">
                <!-- 棋盤與箭頭的組合容器 -->
                <div id="board-container-wrapper">
                    <div id="myBoard"></div> 
                    <!-- SVG 箭頭層 -->
                    <svg id="arrow-overlay" width="560" height="560" viewBox="0 0 560 560">
                        <defs>
                            <marker id="arrowhead-green" markerWidth="4" markerHeight="4" refX="2" refY="2" orient="auto">
                                <polygon points="0 0, 4 2, 0 4" fill="#22c55e" />
                            </marker>
                            <marker id="arrowhead-orange" markerWidth="4" markerHeight="4" refX="2" refY="2" orient="auto">
                                <polygon points="0 0, 4 2, 0 4" fill="#f97316" />
                            </marker>
                        </defs>
                        </svg>
                </div>
                <!-- 選項區 -->
                <div id="board-options">
                      <div>
                          <label for="board-theme-select">棋盤顏色:</label>
                          <select id="board-theme-select">
                              <option value="wood">木紋</option>
                              <option value="green" selected>綠色</option>
                              <option value="blue">藍色</option>
                              <option value="grey">灰色</option>
                          </select>
                      </div>
                      <div>
                          <label for="piece-theme-select">棋子樣式:</label>
                          <select id="piece-theme-select">
                              <option value="wikipedia">維基</option>
                              <option value="neo">Neo</option>
                          </select>
                      </div>
                </div>
            </div> 
        </div> 

        <!-- 右側：分析區 -->
        <div id="sidebar">
            <div id="analysis-controls">
                <!-- 開局名稱 -->
                <div id="opening-name-display"></div>
                <!-- 勝率 -->
                <div id="win-rate-text">白方: 50% | 黑方: 50%</div>
                <div id="win-rate-bar-container">
                    <div id="white-bar"></div>
                </div>
                <!-- 控制按鈕 -->
                <div id="move-controls">
                    <button id="prev-move">&lt; 上一手</button>
                    <button id="next-move">下一手 &gt;</button>
                    <button id="flip-board-button">翻轉棋盤</button>
                    <button id="mute-toggle-button">
                        <img id="mute-icon" src="icons/volume_on.png" alt="Mute/Unmute">
                    </button>
                </div>
                <!-- 總結 -->
                <h4 id="summary-toggle">對局總結 (點擊展開/收合) &#9662;</h4>
                <div id="analysis-summary-content" style="display: none;"></div>
                <!-- 分析列表 -->
                <div id="analysis-container">
                    <h3>分析結果</h3>
                    <p>請上傳 PGN 或貼上內容分析。</p>
                </div>
            </div>
        </div> 

    </div> 

    <!-- JS 函式庫 -->
    <script src="js/jquery.min.js"></script>
    <script src="js/chessboard-1.0.0.min.js"></script>

    <!-- 我們的 JS -->
    <script src="app.js"></script>

    <!-- 聲音 -->
    <audio id="move-sound" src="sounds/move-self.mp3" preload="auto"></audio>
    <audio id="check-sound" src="sounds/check.mp3" preload="auto"></audio>

</body>
</html>